# 5/6 System Design

Date: May 6, 2022 11:21 PM

### 처리율 제한 장치

: 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치

- e.g) 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
- 장점
    - DoS 공격에 의한 자원 고갈 방지
    - 비용 절감 - 추가 요청에 대한 처리를 제한하면 서버를 많이 두지 않고 우선순위가 높은 API에 더 많은 자원 할당이 가능하다.
    - 과부하를 막는다

### 문제 이해 및 설계 범위 확정

- 처리율 제한 장치 구현에는 여러가지 알고리즘이 존재한다.
- 서버측 제한 장치인가 클라이언트 측 제한 장치인가?
- 어떤 기준으로 제어하는가 IP주소? 사용자 ID?
- 시스템 규모는?
- 분산 환경에서 동작하는지?
- 독립된 서비스인지 아니면 애플리케이션 코드에 포함될 수도 있는지?
- 요구사항 예시
    - 설정된 처리율을 초과하는 요청은 정확하게 제한
    - HTTP 응답시간에 나쁜 영향을 주어서는 안 된다
    - 가능한 적은 메모리를 사용할 것
    - 분산형 처리율 제한 : 하나의 처리율 제한 장치를 여러 서버나 프로세스에서 공유 가능할 것
    - 예외 처리 : 요청이 제한될 경우 그 사실을 사용자에게 보여줄 것
    - 높은 결함 감내성 : 제한 장치에 장애가 생기더라도 전체 시스템에 영향을 주어서는 안 된다.

### 계략적 설계안 제시 및 동의 구하기

- 클라이언트 측에 처리율 제한 장치를 설치할 경우 위변조가 가능해 통제에 어려움이 있다.
- API 서버에 두는 대신 middle ware로 만들어 요청을 통제하도록 할 수 있다.
- 클라우드 마이크로 서비스의 경우 처리율 제한 장치는 보통 API Gateway라 불리는 컴포넌트에 구현된다.
- 처리율 제한 기능이 어디에 있어야 하는가에 대한 정답은 없다 현재 기술 스택이나 엔지니어링 인력, 우선순위, 목표에 따라 달라질 수 있기 때문이다.
- 고려사항
    - 프로그래밍 언어, 캐시 서비스 등 현재 사용하고 있는 기술 스택
    - 사업 필요에 맞는 처리율 제한 알고리즘
    - 회사 내에서 충분히 구현이 가능한지? 불가능 하다면 클라우드 업체의 API Gateway를 사용하는 것이 바람직하다.
- 처리율 제한 알고리즘
    - 토큰 버킷(token bucket)
    - 누출 버킷(leaky bucket)
    - 고정 윈도 카운터(fixed window counter)
    - 이동 윈도 로그(sliding window log)
    - 이동 윈도 카운터(sliding window counter)
- 토큰 버킷 알고리즘
    - 지정된 용량을 갖는 컨테이너(버킷)에 설정된 양의 토큰이 주기적으로 채워지고 요청 하나 당 토큰이 하나씩 주어지며 토큰이 할당되지 않는 요청은 버려진다.
    - 버킷 크기, 토큰 공급률 이 두가지 인자가 필요하다
    - 통상적으로 API 엔드포인트마다 별도의 버킷을 둔다.
    - IP 주소별 처리율 제한이 필요하다면 IP 주소마다 버킷을 하나씩 할당한다.
    - 시스템의 처리율이 초당 10,000개 요청으로 제한하고 싶다면, 모든 요청이 하나의 버킷을 공유하도록 해야 할 것이다.
    - 장점
        - 구현이 쉽다.
        - 메모리 사용 측면에서 효율적이다
        - 짧은 시간에 집중되는 트래픽 처리 가능
    - 단점
        - 두 개의 인자만으로 적절하게 튜닝하는 것은 까다롭다.